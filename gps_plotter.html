<html>
<head>
<style type="text/css">
body {
	margin: auto;
	text-align: center;
}

#gmaps_div {
    width: 480px;
    height: 360px; 
	margin: auto;
    display: inline-block;
}

#LIDAR_IMU_canvas {
    background: lightGray;
}
</style>
</head>

<body>
<h3>Granny Web Portal 2.0</h3>

<div id="gmaps_div"></div>
<canvas id="LIDAR_IMU_canvas" height="360" width="500"></canvas>
<br/>
<img id="image_viewer"
     alt="looks like mjpeg server isn't connected properly!"
     id="image" height="360" width="480"/>

<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyDcfZrTqJaJJyX3hxctoJsg7LJXKx6KnPg&sensor=false"
        type="text/javascript"></script>
<script src="http://brown-ros-pkg.googlecode.com/svn/tags/brown-ros-pkg/rosbridge/ros.js"
        type="text/javascript"></script>
<script type="text/javascript">

var DOMAIN = "doloras.kicks-ass.org",
    // DOMAIN = "localhost",
    IMAGE_DATA_URL = "http://"+DOMAIN+":8080/stream?topic=/usb_cam/image_raw",
    START_LON =  30.2954,
    START_LAT = -97.7402,
    REBOUND_MAP = false,
    ANIMATION_RATE = 1;

//
// mjpeg_server image streamer
//

function init_image_viewer() {
    document.getElementById('image_viewer').setAttribute('src', IMAGE_DATA_URL);
}

//
// Google mapping stuff
//

var gmapsInterface = function () {
    var map, 
        num_coords = 0, 
        that = {};

    that.load = function () {
        map = new google.maps.Map(document.getElementById("gmaps_div"), {
            mapTypeId: google.maps.MapTypeId.HYBRID,
            center: new google.maps.LatLng(START_LON, START_LAT),
            zoom: 20,
            tilt: 0
        });
    };

    that.draw = function (pos) {
        var marker, latlngbounds;

        marker = new google.maps.Marker({
            map: map,
            position: pos,
            flat: true,
            title: num_coords+"" 
        });

        // recalculate bounds for first point
        if (REBOUND_MAP && 0 == num_coords) {
            latlngbounds = new google.maps.LatLngBounds();
            latlngbounds.extend(pos);

            map.setCenter(latlngbounds.getCenter(), map.fitBounds(latlngbounds));
        }

        num_coords += 1;
    };

    return that;
}();

//
// Canvas interface
//

var canvasInterface = function () {
    var canvas, 
        context, 
        curScanPoints,
        curYaw,
        that = {};

    var drawPoints = function (points) {
        var context = document.getElementById("canvas").getContext("2d");

        context.lineWidth = .1;
        context.strokeStyle = "gray";
        context.fillStyle = "black";

        for (var i = 0; i < curScanPoints.length; i++) {
            context.beginPath();
            context.moveTo(0, 0);
            context.lineTo(curScanPoints[i][0], curScanPoints[i][1]);
            context.stroke();
        }

        for (var i = 0; i < points.length; i++) {
            if (curScanPoints[i][2]) {
                context.beginPath();
                context.arc(curScanPoints[i][0], curScanPoints[i][1], .05, 0, 2*Math.PI, true);
                context.fill();
            }
        }
    };

    var draw = function () {
        if (curYaw) {
    
        }

        if (curScanPoints) {
            drawPoints(curScanPoints);
        }
    };

    that.init = function() {
        canvas = document.getElementById("LIDAR_IMU_canvas"),
        context = canvas.getContext('2d');
        setInterval(function () { draw(); }, 1000/ANIMATION_RATE);
    };
    
    that.setLIDAR = function (data) {
        var angle, i, range, isValid,
            max_range = data.range_max,
            min_angle = data.angle_min,
            max_angle = data.angle_max,
            angle_inc = data.angle_increment;

        if (!curScanPoints) {
            curScanPoints = new Array(data.ranges.length);

            for (i = 0; i < data.ranges.length; i++) {
                curScanPoints = new Array(3);
            }
        }

        angle = min_angle

        for (i = 0; i < data.ranges[i].length; i++) {
            range = data.ranges[i];
            isValid = true;

            if (0 == range) {
                range = max_range;
                isValid = false;
            }

            curScanPoints[i][0] = range*Math.cos(angle);
            curScanPoints[i][1] = range*Math.sin(angle);
            curScanPoints[i][2] = isValid;

            angle += angle_inc;
        }
    };

    that.setYaw = function (yaw) {
        curYaw = yaw;
    };

    return that;
}();

//
// ROS topic callbacks
//

var handlers = {
    um6_imu_handler: function (data) {
        // console.log("imu data!");
    },

    lidar_handler: function (data) {
        // console.log("lidar data!");
    },

    ekf_handler: function (data) {
        var x = data.x_pos,
            y = data.y_pos;
    },

    gps_handler: function (data) {
        var lon = data.latitude,
            lat = data.longitude,
            pos = new google.maps.LatLng(lon, lat);

        gmapsInterface.draw(pos);
    }
};

//
// Websocket stuff
//

var topics = [
/*
    { topicName: "/ekf_data", 
      dataName: "ekf data", 
      handler: handlers.ekf_handler,
      rate: 15 },

    { topicName: "/gps_data_raw", 
      dataName: "gps data", 
      handler: handlers.gps_handler,
      rate: 1 }
*/
    { topicName: "/scan", 
      dataName: "lidar data", 
      handler: handlers.lidar_handler,
      rate: 15 },
    { topicName: "/um6_imu_data", 
      dataName: "um6 imu data", 
      handler: handlers.um6_imu_handler,
      rate: 19 },
];

(function () {
    var i, connection = new ros.Connection("ws://"+DOMAIN+":9090");

    connection.setOnClose(function (e) {
        console.log('connection closed');
    });

    connection.setOnError(function (e) {
        console.log('error:', e);
    });

    var makeAnnouncer = function(name) {
        return function (e) {
            console.log("connected to " + name + "!", e);
        };
    };

    for (i = 0; i < topics.length; i++) {
        connection.addHandler(topics[i].topicName, topics[i].handler);
    }

    connection.setOnOpen(function (e) {
        console.log('connected to ROS');
        
        for (i = 0; i < topics.length; i++) { 
            connection.callService(
                '/rosjs/subscribe', 
                '["' + topics[i].topicName + '", ' + (1000/topics[i].rate) + ']',
                makeAnnouncer(topics[i].topicName)
            );
        }
    });
})();

//
// Startup
//

window.onload = function () { 
    gmapsInterface.load(); 
    init_image_viewer();
    canvasInterface.init();
};

window.onunload = function () { google.maps.GUnload(); };

</script>


</body>
</html>

